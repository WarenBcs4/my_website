{% extends 'main/base.html' %}
{% block content %}
  <h2>Chat: {{ room_name }}</h2>
  <div id="chat-log" style="height: 50vh; overflow:auto; background:#f8f9fa; padding:10px;">
    {% for m in messages %}
      <div class="mb-2"><strong>{{ m.sender.username if m.sender else 'Anon' }}:</strong> {{ m.message }} <small class="text-muted">{{ m.timestamp }}</small></div>
    {% endfor %}
  </div>

  <div class="input-group mt-3">
    <input id="chat-message-input" type="text" class="form-control" placeholder="Type a message...">
    <button id="chat-message-submit" class="btn btn-primary">Send</button>
  </div>

{% endblock %}

{% block scripts %}
<script>
const roomName = '{{ room_name }}';
const username = '{{ request.user.username|escapejs }}' || 'Anonymous';
const wsProtocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
const chatSocket = new WebSocket(wsProtocol + '://' + window.location.host + '/ws/chat/' + roomName + '/');

chatSocket.onmessage = function(e) {
  const data = JSON.parse(e.data);
  const log = document.getElementById('chat-log');
  const div = document.createElement('div');
  div.className = 'mb-2';
  div.innerHTML = '<strong>' + data.username + ':</strong> ' + data.message + ' <small class="text-muted">' + data.timestamp + '</small>';
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
};

chatSocket.onclose = function(e) {
  console.error('Chat socket closed unexpectedly');
};

document.getElementById('chat-message-submit').onclick = function() {
  const inputEl = document.getElementById('chat-message-input');
  const message = inputEl.value;
  if (!message) return;
  chatSocket.send(JSON.stringify({ 'message': message, 'username': username }));
  inputEl.value = '';
};
</script>
{% endblock %}