{% extends 'main/base.html' %}
{% block content %}
  <h2 class="text-info mb-4 fs-3">Chat: {{ room_name }}</h2>
  <div id="chat-log" style="height: 50vh; overflow:auto; background:#f8f9fa; padding:10px;">
    {% for m in messages %}
      <div class="mb-2">
        <strong>
          {% if m.sender %}
            {{ m.sender.username }}
          {% else %}
            Anon
          {% endif %}
        </strong>: 
        {{ m.message }} 
        <small class="text-muted">{{ m.timestamp }}</small>
      </div>
    {% endfor %}
  </div>

  <div class="input-group mt-3 text-info">
    <input id="chat-message-input" type="text" class="form-control" placeholder="Type a message...">
    <button id="chat-message-submit" class="btn btn-primary ">Send</button>
  </div>


  <script>
const roomName = "{{ room_name|escapejs }}";

const chatSocket = new WebSocket(
  (window.location.protocol === "https:" ? "wss://" : "ws://") +
  window.location.host +
  "/ws/chat/" +
  roomName +
  "/"
);

chatSocket.onmessage = function(e) {
  const data = JSON.parse(e.data);
  const chatLog = document.querySelector("#chat-log");
  chatLog.innerHTML += "<p><b>" + data.sender + ":</b> " + data.message + "</p>";
  chatLog.scrollTop = chatLog.scrollHeight;
};

document.querySelector("#chat-message-input").focus();
document.querySelector("#chat-message-input").onkeyup = function(e) {
  if (e.keyCode === 13) {  // enter
    document.querySelector("#chat-message-submit").click();
  }
};

document.querySelector("#chat-message-submit").onclick = function(e) {
  const inputField = document.querySelector("#chat-message-input");
  const message = inputField.value;
  chatSocket.send(JSON.stringify({ "message": message }));
  inputField.value = "";
};
</script>

{% endblock %}
